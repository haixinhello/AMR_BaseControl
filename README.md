##  项目简介

`AMR_BaseControl` 是一个为导航建图小车设计的下位机控制系统。  
上位机（树莓派 + ROS2）通过串口发送运动指令 (`Twist`)，  
下位机解析后控制电机转速与转向角，同时实时反馈里程计数据 (`Odom`)。

项目采用：
- **阿克曼运动学模型**
- **PID 速度闭环控制**
- **自定义串口通信协议**
- **FreeRTOS 多任务架构**

---

##  硬件与软件环境

| 类型 | 说明 |
|------|------|
| 控制主芯片 | STM32F407 |
| 开发环境 | STM32CubeIDE |
| 操作系统 | FreeRTOS（CMSIS_V1 自动生成） |
| 电机驱动 | AT8236 |
| 电机型号 | MG513P30_12V |
| 编码器类型 | GMR 编码器 |
| 通信方式 | UART 串口（自定义协议） |
| 上位机系统 | Ubuntu + ROS2 |

---

##  系统功能结构

1. 解析上位机发送的 `Twist` 数据（线速度、角速度）  
2. 基于阿克曼模型计算前轮转角与后轮目标速度  
3. 使用 PID 控制实现电机速度闭环  
4. 计算并发布里程计（Odom）信息  
5. 欧拉角 → 四元数转换，用于姿态表示  

---

##  通信协议说明

###   Twist 指令格式（上位机 → 下位机）

| 字节序 | 内容 | 说明 |
|--------|------|------|
| Byte0 | 包头 | 固定值 `0xAA` |
| Byte1 | linear_x 高 8 位 | 线速度（mm/s）高字节 |
| Byte2 | linear_x 低 8 位 | 线速度低字节 |
| Byte3 | angular_z 高 8 位 | 角速度（rad/s）高字节 |
| Byte4 | angular_z 低 8 位 | 角速度低字节 |
| Byte5 | 包尾 | 固定值 `0x55` |

> 下位机接收到该数据包后，将解析线速度和角速度并更新运动控制。

---

###   Odom 数据格式（下位机 → 上位机）

| 字节序 | 内容 | 说明 |
|--------|------|------|
| Byte0 | 包头 | 固定值 `0xAA` |
| Byte1-2 | x 高、低 8 位 | 当前坐标 X（mm） |
| Byte3-4 | y 高、低 8 位 | 当前坐标 Y（mm） |
| Byte5-12 | qx, qy, qz, qw | 四元数姿态（欧拉角 → 四元数） |
| Byte13-14 | linear_speed | 线速度（m/s） |
| Byte15-16 | angular_speed | 角速度（rad/s） |
| Byte17 | 包尾 | 固定值 `0x55` |

> 四元数由欧拉角 yaw 计算得出，便于 ROS2 中 `nav_msgs/Odometry` 使用。

---

##  核心算法模块

###  `Kinematics.cpp`
主要功能：
- 欧拉角 → 四元数转换  
- 正/逆运动学计算  
- 里程计更新与角度归一化  
- 电机参数配置（减速比、脉冲比、轮径等）  

###  `PidController.cpp`
主要功能：
- PID 比例、积分、微分控制  
- 支持积分限幅与输出限幅  
- 动态更新目标值与 PID 参数  
- 用于电机转速闭环控制  

---
